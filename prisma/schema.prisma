// =============================================================================
// The Artful Experience - Prisma Schema
// Rebuilt 2026-01-19 for reliable server deployment
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// =============================================================================
// SHOP PRODUCTS - Master Product Types (Single Source of Truth)
// =============================================================================

// Shop Categories define the master product types available for purchase
// These are used across Shop, Gallery, and CoCreator pages
model ShopCategory {
  id              String   @id @default(cuid())
  taeId           String   @unique  // e.g., "TAE-CARD", "TAE-CANVAS", "TAE-WALL"
  slug            String   @unique  // URL-friendly: "cards", "canvas-prints"
  name            String             // Display: "Greeting Cards", "Canvas Prints"
  description     String?
  icon            String?            // Emoji or icon identifier

  // Gelato mapping
  gelatoCatalogUid String?           // Maps to Gelato catalog (e.g., "folded-cards")

  // Pricing
  taeBaseFee      Float   @default(0)  // tAE markup added to all products in this category

  // QR Code option
  requiresQrCode  Boolean @default(false)  // If true, products in this category need QR codes

  // Display
  heroImage       String?
  active          Boolean @default(true)
  featured        Boolean @default(false)
  sortOrder       Int     @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  products        ShopProduct[]
  artworkLinks    ArtworkProductLink[]

  @@index([slug])
  @@index([active])
  @@index([taeId])
}

// Shop Products - Individual products within a category with variations
model ShopProduct {
  id              String   @id @default(cuid())
  taeId           String   @unique  // e.g., "TAE-CARD-001", "TAE-CANVAS-001"
  categoryId      String
  slug            String   @unique
  name            String             // e.g., "5x7 Folded Card", "16x20 Canvas"
  description     String?

  // Gelato mapping (hidden from customers)
  gelatoProductUid String?           // Gelato's full product UID

  // Pricing structure
  gelatoBasePrice Float   @default(0)  // Cost from Gelato API (auto-synced)
  taeAddOnFee     Float   @default(0)  // Our markup for this specific product
  // Final price = gelatoBasePrice + category.taeBaseFee + taeAddOnFee + artistRoyalty (if applicable)

  // Product specs
  sizeLabel       String?            // e.g., "5x7", "16x20"
  paperType       String?
  finishType      String?
  orientation     String?            // "horizontal", "vertical", "square"

  // Display
  heroImage       String?
  active          Boolean @default(true)
  sortOrder       Int     @default(0)

  // Metadata (synced from Gelato)
  gelatoDataJson  String?            // Full Gelato product data as JSON
  lastSyncedAt    DateTime?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  category        ShopCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orderItems      OrderItem[]

  @@index([categoryId])
  @@index([slug])
  @@index([taeId])
  @@index([active])
}

// =============================================================================
// ARTISTS & GALLERY - Artist Artwork Products
// =============================================================================

model Artist {
  id              String   @id @default(cuid())
  slug            String   @unique
  name            String
  title           String?            // e.g., "PHOTOGRAPHER | EXPLORER | FOUNDER"
  bio             String?
  description     String?            // Extended description

  // Images
  thumbnailImage  String?            // Small profile image
  bioImage        String?            // Large bio/hero image

  // Artist royalty (flat fee per product sold)
  royaltyFee      Float   @default(0)  // Added to price for all their artwork sales

  // Display
  active          Boolean @default(true)
  featured        Boolean @default(false)
  sortOrder       Int     @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  artworks        ArtistArtwork[]

  @@index([slug])
  @@index([active])
}

// Artist Artwork - Gallery images that can be purchased as products
model ArtistArtwork {
  id              String   @id @default(cuid())
  artistId        String
  taeId           String   @unique  // e.g., "TAE-ART-BC-001" (Bryant Colman #1)
  slug            String   @unique
  title           String
  description     String?

  // Image
  imageUrl        String             // Full-resolution image URL
  thumbnailUrl    String?            // Optional thumbnail

  // For sale settings
  forSale         Boolean @default(true)

  // Display
  active          Boolean @default(true)
  featured        Boolean @default(false)
  sortOrder       Int     @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  artist          Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)
  productLinks    ArtworkProductLink[]
  orderItems      OrderItem[]

  @@index([artistId])
  @@index([slug])
  @@index([taeId])
  @@index([forSale])
  @@index([active])
}

// Junction table: Which shop products can an artwork be purchased as?
model ArtworkProductLink {
  id              String   @id @default(cuid())
  artworkId       String
  categoryId      String

  // Timestamps
  createdAt       DateTime @default(now())

  // Relations
  artwork         ArtistArtwork @relation(fields: [artworkId], references: [id], onDelete: Cascade)
  category        ShopCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([artworkId, categoryId])
  @@index([artworkId])
  @@index([categoryId])
}

// =============================================================================
// COCREATORS - Collaborator Products
// =============================================================================

model CoCreator {
  id              String   @id @default(cuid())
  slug            String   @unique
  name            String
  title           String?            // e.g., "ADAPTIVE ALPINE CLIMBER | ATHLETE | EDUCATOR"
  bio             String?
  description     String?

  // Images
  thumbnailImage  String?
  heroImage       String?            // Mountain image or similar

  // Royalty
  royaltyFee      Float   @default(0)

  // Display
  active          Boolean @default(true)
  featured        Boolean @default(false)
  sortOrder       Int     @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  collaborations  CoCreatorProduct[]

  @@index([slug])
  @@index([active])
}

// CoCreator collaboration products
model CoCreatorProduct {
  id              String   @id @default(cuid())
  cocreatorId     String
  taeId           String   @unique  // e.g., "TAE-COLLAB-KC-001"
  slug            String   @unique
  title           String
  description     String?

  // Image
  imageUrl        String
  thumbnailUrl    String?

  // For sale
  forSale         Boolean @default(true)

  // Display
  active          Boolean @default(true)
  sortOrder       Int     @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  cocreator       CoCreator @relation(fields: [cocreatorId], references: [id], onDelete: Cascade)

  @@index([cocreatorId])
  @@index([slug])
  @@index([taeId])
}

// =============================================================================
// CUSTOMERS - Local customer data with Gelato reference
// =============================================================================

model Customer {
  id                  String   @id @default(cuid())
  email               String   @unique
  name                String?
  phone               String?

  // Gelato reference (for API lookups)
  gelatoCustomerId    String?  @unique  // Gelato's customer reference ID

  // Admin notes
  notes               String?

  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  orders              Order[]

  @@index([email])
  @@index([gelatoCustomerId])
}

// =============================================================================
// ORDERS
// =============================================================================

model Order {
  id                String   @id @default(cuid())
  orderNumber       String   @unique  // tAE order number (e.g., "TAE-ORD-20260119-001")
  status            String   @default("pending")

  // Customer reference
  customerId        String?

  // Snapshot at purchase (stored locally)
  customerEmail     String?
  customerName      String?

  // Pricing snapshot
  subtotal          Float
  shippingCost      Float    @default(0)
  totalRoyalties    Float    @default(0)
  total             Float

  // Gelato reference (for API lookups - don't store sensitive data)
  gelatoOrderId     String?  @unique
  gelatoStatus      String?

  // Tracking (can be fetched from Gelato or stored after webhook)
  trackingNumber    String?
  trackingUrl       String?
  carrier           String?

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  customer          Customer? @relation(fields: [customerId], references: [id])
  items             OrderItem[]

  @@index([status])
  @@index([orderNumber])
  @@index([customerEmail])
  @@index([customerId])
  @@index([gelatoOrderId])
}

model OrderItem {
  id                String   @id @default(cuid())
  orderId           String

  // What was purchased
  shopProductId     String?           // If standard shop product
  artworkId         String?           // If artist artwork

  // Snapshot at purchase
  itemType          String            // "shop_product" | "artist_artwork" | "cocreator_product"
  itemName          String
  itemTaeId         String            // The tAE ID at time of purchase
  quantity          Int      @default(1)

  // Pricing snapshot
  basePrice         Float             // Gelato base
  taeAddOnFee       Float    @default(0)
  artistRoyalty     Float    @default(0)
  unitPrice         Float             // Final per-unit price

  // QR Code (if product required it)
  artKeyId          String?           // Reference to ArtKey portal
  qrCodeUrl         String?           // Generated QR code image

  // Design (if customizable)
  designDraftId     String?

  // Timestamps
  createdAt         DateTime @default(now())

  // Relations
  order             Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shopProduct       ShopProduct? @relation(fields: [shopProductId], references: [id], onDelete: SetNull)
  artwork           ArtistArtwork? @relation(fields: [artworkId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([shopProductId])
  @@index([artworkId])
}

// =============================================================================
// GELATO SYNC - Track sync operations
// =============================================================================

model GelatoSyncLog {
  id              String   @id @default(cuid())
  syncType        String             // "catalog" | "products" | "prices" | "full"
  status          String             // "started" | "completed" | "failed"

  // Stats
  itemsProcessed  Int      @default(0)
  itemsUpdated    Int      @default(0)
  itemsFailed     Int      @default(0)

  // Error tracking
  errorMessage    String?
  errorDetails    String?            // JSON with detailed errors

  // Timestamps
  startedAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([syncType])
  @@index([status])
  @@index([startedAt])
}

// Gelato Product Cache - Local cache of Gelato products for fast frontend loading
model GelatoProductCache {
  id              String   @id @default(cuid())

  // Category mapping (our category â†’ Gelato catalog)
  categorySlug    String             // "wall-art", "canvas-prints", "framed-prints"
  gelatoCatalog   String             // "posters", "canvas", "framedposters"

  // Product info from Gelato
  gelatoProductUid String  @unique   // Gelato's product UID
  productName     String             // Human-readable name

  // Variant attributes
  size            String             // "12x18", "16x20", etc.
  sizeLabel       String             // "12\" x 18\"" display label
  paperType       String?            // Paper/material type
  frameColor      String?            // Frame color (for framed prints)
  orientation     String?            // "horizontal", "vertical", "square"

  // Pricing (in USD)
  gelatoPrice     Float              // Base cost from Gelato
  shippingEstimate Float  @default(0) // Estimated shipping cost

  // Availability
  available       Boolean @default(true)
  supportedCountries String?         // JSON array of country codes

  // Dimensions (for print specs)
  widthMm         Float?
  heightMm        Float?
  widthInches     Float?
  heightInches    Float?

  // Full Gelato response (for debugging/reference)
  rawDataJson     String?            // Full product data as JSON

  // Timestamps
  lastSyncedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([categorySlug, size, paperType, frameColor])
  @@index([categorySlug])
  @@index([gelatoCatalog])
  @@index([available])
  @@index([size])
}

// =============================================================================
// ARTKEY PORTAL - Keep existing functionality
// =============================================================================

model ArtKey {
  id            String   @id @default(cuid())
  publicToken   String   @unique
  ownerToken    String   @unique
  ownerEmail    String?

  // Portal content
  title         String
  theme         String   // JSON
  features      String   // JSON
  links         String   // JSON
  spotify       String   // JSON
  featuredVideo String?  // JSON
  customizations String  // JSON

  // Media
  uploadedImages String  // JSON array
  uploadedVideos String  // JSON array

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  guestbookEntries GuestbookEntry[]
  mediaItems       MediaItem[]

  @@index([publicToken])
  @@index([ownerToken])
}

model GuestbookEntry {
  id        String   @id @default(cuid())
  artkeyId  String
  parentId  String?
  name      String
  email     String?
  message   String
  role      String   @default("guest")
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())

  artkey    ArtKey   @relation(fields: [artkeyId], references: [id], onDelete: Cascade)
  parent    GuestbookEntry? @relation("GuestbookReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   GuestbookEntry[] @relation("GuestbookReplies")
  mediaItems MediaItem[]

  @@index([artkeyId])
  @@index([parentId])
  @@index([approved])
}

model MediaItem {
  id               String   @id @default(cuid())
  artkeyId         String
  guestbookEntryId String?
  type             String
  url              String
  caption          String?
  approved         Boolean  @default(false)
  createdAt        DateTime @default(now())

  artkey          ArtKey          @relation(fields: [artkeyId], references: [id], onDelete: Cascade)
  guestbookEntry  GuestbookEntry? @relation(fields: [guestbookEntryId], references: [id], onDelete: SetNull)

  @@index([artkeyId])
  @@index([guestbookEntryId])
  @@index([approved])
}

// =============================================================================
// DESIGN DRAFTS - Keep existing functionality
// =============================================================================

model DesignDraft {
  id                String   @id @default(cuid())
  productId         String?
  variantId         String?
  printSpecId       String
  dpi               Int       @default(300)
  cornerStyle       String   @default("square")
  cornerRadiusMm    Float    @default(0)

  designJsonFront   String?
  designJsonBack    String?
  previewPngFront   String?
  previewPngBack    String?
  artKeyData        String?
  usedAssetIds      String?
  premiumFees       Float     @default(0)
  status            String   @default("draft")
  sessionId         String?
  userId            String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([sessionId])
  @@index([userId])
  @@index([status])
  @@index([productId])
}
