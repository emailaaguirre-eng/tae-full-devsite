// Prisma schema for ArtKey Portal
// This schema supports the full ArtKey experience: editor, public portal, and owner management

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model ArtKey {
  id            String   @id @default(cuid())
  publicToken  String   @unique // Short, URL-friendly token for public access (e.g., rkN93dX4)
  ownerToken   String   @unique // Secret token for owner/host management
  ownerEmail   String?  // Optional email for the owner
  
  // Core ArtKey data (stored as JSON to match ArtKeyEditor structure)
  title         String
  theme         String  // JSON: { template, bg_color, bg_image_url, font, text_color, title_color, etc. }
  features      String  // JSON: { enable_gallery, show_guestbook, gb_require_approval, etc. }
  links         String  // JSON array: [{ label, url }]
  spotify       String  // JSON: { url, autoplay }
  featuredVideo String? // JSON: { video_url, button_label } or null
  customizations String // JSON: { skeleton_key, qr_position, etc. }
  
  // Media arrays (stored as JSON for backward compatibility, but also tracked in MediaItem)
  uploadedImages String // JSON array of URLs
  uploadedVideos String // JSON array of URLs
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  guestbookEntries GuestbookEntry[]
  mediaItems       MediaItem[]
  
  @@index([publicToken])
  @@index([ownerToken])
}

model GuestbookEntry {
  id        String   @id @default(cuid())
  artkeyId  String
  parentId  String?  // For threaded comments/replies
  name      String
  email     String?  // Optional email for guest entries
  message   String
  role      String   @default("guest") // "guest" | "host" - distinguishes guest entries from host replies
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // Relations
  artkey    ArtKey   @relation(fields: [artkeyId], references: [id], onDelete: Cascade)
  parent    GuestbookEntry? @relation("GuestbookReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   GuestbookEntry[] @relation("GuestbookReplies")
  mediaItems MediaItem[]
  
  @@index([artkeyId])
  @@index([parentId])
  @@index([approved])
  @@index([role])
}

model MediaItem {
  id               String   @id @default(cuid())
  artkeyId         String
  guestbookEntryId String?  // Optional: media attached to a guestbook entry
  type             String   // "image" | "video" | "audio"
  url              String   // Full URL or path to the file
  caption          String?  // Optional caption
  approved         Boolean  @default(false)
  createdAt        DateTime @default(now())
  
  // Relations
  artkey          ArtKey          @relation(fields: [artkeyId], references: [id], onDelete: Cascade)
  guestbookEntry  GuestbookEntry? @relation(fields: [guestbookEntryId], references: [id], onDelete: SetNull)
  
  @@index([artkeyId])
  @@index([guestbookEntryId])
  @@index([approved])
  @@index([type])
}


model DesignDraft {
  id                String   @id @default(cuid())
  productId         String?  // Product from Lane A
  variantId         String?
  printSpecId       String
  dpi               Int       @default(300)
  cornerStyle       String   @default("square") // "square" | "rounded"
  cornerRadiusMm    Float    @default(0)
  
  // Design data (JSON strings)
  designJsonFront   String?   // Konva layer.toJSON() for front
  designJsonBack    String?   // Konva layer.toJSON() for back
  
  // Preview images (base64 for MVP)
  previewPngFront   String?   // base64 data URL
  previewPngBack    String?   // base64 data URL
  
  // ArtKey portal data (JSON)
  artKeyData        String?   // JSON: { title, message, media, guestbookSettings, etc. }
  
  // Premium assets used
  usedAssetIds      String?   // JSON array of asset IDs used in design
  premiumFees        Float     @default(0) // Sum of premium fees
  
  // Status tracking
  status            String   @default("draft") // "draft" | "artkey_complete" | "checkout_ready"
  
  // User/session tracking
  sessionId         String?
  userId            String?
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([sessionId])
  @@index([userId])
  @@index([status])
  @@index([productId])
}

// Lane A: Customizable Print Products (Gelato)
model Product {
  id                String   @id @default(cuid())
  slug              String   @unique
  name              String
  description       String?
  category          String   // "card" | "invitation" | "announcement" | "postcard" | "wall-art"
  productType       String   // Gelato product type
  
  // Gelato integration
  gelatoProductUid  String?  // Gelato product UID
  gelatoCatalogUid   String?  // Gelato catalog UID
  
  // Pricing
  basePrice         Float?   // Base price (may come from Gelato)
  
  // Features
  allowsPremiumLibrary Boolean @default(true) // Can use premium assets
  allowsCustomUpload   Boolean @default(true) // Can upload own photos
  
  // Display
  image             String?  // Product image/thumbnail
  active            Boolean  @default(true)
  featured          Boolean  @default(false)
  sortOrder         Int      @default(0)
  
  // Metadata (JSON)
  metadata          String?  // JSON: { options, variants, etc. }
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  orderItems        OrderItem[]
  
  @@index([category])
  @@index([active])
  @@index([featured])
  @@index([slug])
}

// Lane B: Artist Artwork Assets
model Artist {
  id                String   @id @default(cuid())
  slug              String   @unique
  name              String
  title             String?  // Artist title/role
  bio               String?  // Biography
  bioImage          String?  // Artist profile image
  image             String?  // Artist thumbnail
  active            Boolean  @default(true)
  sortOrder         Int      @default(0)
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  assets            Asset[]
  
  @@index([slug])
  @@index([active])
}

model Asset {
  id                      String   @id @default(cuid())
  artistId                String
  title                   String
  image                   String   // Image URL
  description             String?  // Description of the artwork
  slug                    String   @unique
  
  // Lane B Flags
  isForSaleAsPrint        Boolean  @default(false) // Buy as-is print (NOT customizable)
  isAllowedInPremiumLibrary Boolean @default(false) // Use in Premium Library on customizable products
  
  // Premium Library settings
  premiumFee               Float?   // Extra charge when used in premium library
  editRules                String   @default("crop_and_position_only") // "crop_and_position_only" | "full_edit"
  
  // Print sale settings (if isForSaleAsPrint)
  printPrice               Float?   // Price for as-is print
  printProductUid         String?   // Gelato product UID for print
  
  // Display
  active                  Boolean  @default(true)
  featured                Boolean  @default(false)
  sortOrder               Int      @default(0)
  
  // Metadata (JSON)
  metadata                String?  // JSON: { dimensions, medium, year, etc. }
  
  // Timestamps
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  // Relations
  artist                  Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  orderItems               OrderItem[]
  
  @@index([artistId])
  @@index([isForSaleAsPrint])
  @@index([isAllowedInPremiumLibrary])
  @@index([active])
  @@index([featured])
  @@index([slug])
}

// Customer Management
model Customer {
  id                  String   @id @default(cuid())
  email               String   @unique
  name                String?
  phone               String?
  gelatoCustomerRefId String?  // what we pass as customerReferenceId
  addressBookJson     String?  // optional JSON array of past addresses
  
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  orders              Order[]
  
  @@index([email])
}

// Orders and Cart
model Order {
  id                String   @id @default(cuid())
  orderNumber       String   @unique
  status            String   @default("pending")

  customerId        String?
  customer          Customer? @relation(fields: [customerId], references: [id])

  // Snapshot at time of purchase (keep these)
  customerEmail     String?
  customerName      String?
  shippingAddress   String?

  subtotal          Float
  premiumFees       Float    @default(0)
  shipping          Float    @default(0)
  total             Float

  paypalOrderId     String?
  paypalCaptureId   String?

  gelatoOrderId     String?
  gelatoStatus      String?

  // Add these tracking fields (you'll want them immediately)
  trackingNumber    String?
  trackingUrl       String?
  carrier           String?

  designDraftId     String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  items             OrderItem[]

  @@index([status])
  @@index([orderNumber])
  @@index([customerEmail])
  @@index([customerId])
}

model OrderItem {
  id                String   @id @default(cuid())
  orderId           String
  productId         String?  // If from Lane A (customizable product)
  assetId            String?  // If from Lane B (as-is print)
  
  // Product details (snapshot at time of order)
  itemType          String   // "product" | "asset_print"
  itemName           String
  quantity           Int      @default(1)
  unitPrice          Float
  
  // Premium assets used (for products)
  usedAssetIds      String?  // JSON array of asset IDs used in design
  premiumFees        Float    @default(0) // Premium fees for this item
  
  // Design data
  designDraftId     String?  // Link to design draft if customizable
  
  // Timestamps
  createdAt         DateTime @default(now())
  
  // Relations
  order              Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product            Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  asset              Asset?   @relation(fields: [assetId], references: [id], onDelete: SetNull)
  
  @@index([orderId])
  @@index([productId])
  @@index([assetId])
}